<% include ../partials/attendanceHeader%>
<div class="container">
  <h3>View employee</h3>
  <table class="table">
      <label class="pl-3" for="tempatlahir">From:</label>
      <div class="md-form col-xl-3">
        <input name="from" type="date" id="from" required>
      </div>
      <label class="pl-3" for="tempatlahir">Tanggal Lahir</label>
			<div class="md-form col-xl-3">
				<input name="to" type="date" id="to" required>
			</div>
      <button type="button" class="btn btn-primary">Manual</button>

      <table id="dataTable" class="table" cellspacing="0" width="100%">
        <thead>
          <tr>
            <td>NIK</td>
            <td>Nama</td>
            <td>Department</td>
            <td>Atasan Langsung</td>
            <td>Tanggal</td>
            <td>Jam Masuk</td>
            <td>Sign In</td>
            <td>Sign Out</td>
            <td>Jam Kerja</td>
            <td>Telat</td>
          </tr>
        </thead>
        <tbody>

        </tbody>
      </table>


  </table>
</div>

</div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
<script src="/scripts/mdb.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.8/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/1.5.1/js/dataTables.buttons.min.js">
</script>
<script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js">
</script>
<script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/pdfmake.min.js">
</script>
<script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/vfs_fonts.js">
</script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/1.5.1/js/buttons.html5.min.js">
</script>
<script type="text/javascript">

  $(document).ready(function() {
    $('#dataTable').DataTable( {
      dom: 'Bfrtip',
      buttons: [
          'copyHtml5',
          'excelHtml5',
          'pdfHtml5'
      ]
    } );
  } );

  // function loadTable(data){
  //   $('tbody').html(null);
  //   var tr;
  //   for (var i = 0; i < data.length; i++) {
  //       let minTime = moment.min(getTime(data[i].absensi))
  //       let maxTime = moment.max(getTime(data[i].absensi))
  //       let workingHours = moment.utc(maxTime.diff(minTime))
  //       let jam_masuk_toleransi = moment.utc(moment(data[i].jam_masuk).add(5,"minutes").format("HH:mm:ss"),"HH:mm:ss")
  //       let jam_masuk_pertama = moment.utc(minTime.format("HH:mm:ss"),"HH:mm:ss")
  //       tr = $('<tr/>');
  //       tr.append("<td>" + data[i].nik + "</td>");
  //       tr.append("<td>" + data[i].first_Name+" "+(data[i].last_Name?data[i].last_Name:"") + "</td>");
  //       tr.append("<td>" + data[i].department + "</td>");
  //       tr.append("<td>" + (data[i].atasan_langsung?data[i].atasan_langsung:"") + "</td>");
  //       tr.append("<td>" + moment(data[i].absensi[0]["date"]).format("D MMMM YYYY") + "</td>");
  //       tr.append("<td>" + (data[i].jam_masuk?moment(data[i].jam_masuk).format("HH:mm:ss"):"") + "</td>");
  //       tr.append("<td>" + minTime.format("HH:mm:ss") + "</td>");
  //       tr.append("<td>" + maxTime.format("HH:mm:ss") + "</td>");
  //       tr.append("<td>" + workingHours.format("HH:mm:ss") + "</td>");
  //       console.log(data[i].first_Name+":"+moment(data[i].jam_masuk).isBefore(minTime));
  //       tr.append("<td "+(data[i].jam_masuk && jam_masuk_toleransi.isBefore(jam_masuk_pertama)?"style= background-color:red":"")+"></td>");
  //       // tr.append("<td>" + data[i].team + "</td>");
  //       // tr.append("<td>" + data[i].team + "</td>");
  //       $('tbody').append(tr);
  //   }
  // }

  function loadTable(data){
    $('tbody').html(null);
    var tr;
    for (var i = 0; i < data.length; i++) {
        let minTime = moment.min(getTime(data[i].absensi))
        let maxTime = moment.max(getTime(data[i].absensi))
        let workingHours = moment.utc(maxTime.diff(minTime))
        let jam_masuk_toleransi = moment.utc(moment(data[i].jam_masuk).add(5,"minutes").format("HH:mm:ss"),"HH:mm:ss")
        let jam_masuk_pertama = moment.utc(minTime.format("HH:mm:ss"),"HH:mm:ss")
        tr = $('<tr/>');
        tr.append("<td>" + data[i].nik + "</td>");
        tr.append("<td>" + data[i].first_Name+" "+(data[i].last_Name?data[i].last_Name:"") + "</td>");
        tr.append("<td>" + data[i].department + "</td>");
        tr.append("<td>" + (data[i].atasan_langsung?data[i].atasan_langsung:"") + "</td>");
        tr.append("<td>" + moment(data[i].absensi[0]["date"]).format("D MMMM YYYY") + "</td>");
        tr.append("<td>" + (data[i].jam_masuk?moment(data[i].jam_masuk).format("HH:mm:ss"):"") + "</td>");
        tr.append("<td>" + minTime.format("HH:mm:ss") + "</td>");
        tr.append("<td>" + maxTime.format("HH:mm:ss") + "</td>");
        tr.append("<td>" + workingHours.format("HH:mm:ss") + "</td>");
        console.log(data[i].first_Name+":"+moment(data[i].jam_masuk).isBefore(minTime));
        tr.append("<td "+(data[i].jam_masuk && jam_masuk_toleransi.isBefore(jam_masuk_pertama)?"style= background-color:red":"")+"></td>");
        // tr.append("<td>" + data[i].team + "</td>");
        // tr.append("<td>" + data[i].team + "</td>");
        $('tbody').append(tr);
    }
  }

  function getTime(datas){
    return datas.map((data)=>{
      return moment(data["date"])
    })
  }

  $('button').on('click',()=>{
    console.log("trigger");
    let fromDate=new Date($('#from').val());
    let fromString=fromDate.getFullYear()+"-"+(fromDate.getMonth()+1)+"-"+fromDate.getDate()
    let toDate=new Date($('#to').val());
    let toString=toDate.getFullYear()+"-"+(toDate.getMonth()+1)+"-"+toDate.getDate()
    $.getJSON("/api/attendances",{from:fromString,to:toString})
    .then((data)=>{
      console.log(data);
      loadTable(data)
    })
  })
</script>
</body>

</html>
